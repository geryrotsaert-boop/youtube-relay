<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>YouTube Relay API - DJ Videos</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; background: #000; }
        #player { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #error {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #fff;
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body>
    <div id="player"></div>
    <div id="error">
        <h1>⚠️ Erreur</h1>
        <p>Impossible de charger le lecteur YouTube</p>
    </div>
    
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        let player = null;
        let isReady = false;
        
        // Récupérer les paramètres URL
        const urlParams = new URLSearchParams(window.location.search);
        const initialVideoId = urlParams.get('v');
        const playerId = urlParams.get('playerId') || 'relay-player';
        const autoplay = urlParams.get('autoplay') !== '0';
        const controls = urlParams.get('controls') !== '0';
        
        console.log('[RELAY] Initialized with playerId:', playerId, 'videoId:', initialVideoId);
        
        // Envoyer message au parent dans le format attendu par le proxy
        function sendToParent(type, extraData) {
            if (window.parent === window) return;
            
            const message = {
                type: type,
                playerId: playerId,
                ...extraData
            };
            
            console.log('[RELAY] Sending:', message);
            window.parent.postMessage(message, '*');
        }
        
        // Envoyer les infos vidéo
        function sendVideoInfo() {
            if (!player || !isReady) return;
            try {
                const videoData = player.getVideoData();
                sendToParent('videoInfo', {
                    title: videoData.title || '',
                    author: videoData.author || '',
                    video_id: videoData.video_id || ''
                });
            } catch(e) {
                console.log('[RELAY] Could not get video data:', e);
            }
        }
        
        // Timer pour envoyer currentTime régulièrement
        setInterval(function() {
            if (player && isReady) {
                try {
                    sendToParent('timeUpdate', {
                        currentTime: player.getCurrentTime(),
                        duration: player.getDuration()
                    });
                } catch(e) {}
            }
        }, 1000);
        
        function onYouTubeIframeAPIReady() {
            console.log('[RELAY] YouTube API Ready');
            
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                videoId: initialVideoId || '',
                host: 'https://www.youtube-nocookie.com',
                playerVars: {
                    'autoplay': autoplay ? 1 : 0,
                    'controls': controls ? 1 : 0,
                    'rel': 0,
                    'fs': 1,
                    'modestbranding': 1,
                    'enablejsapi': 1,
                    'origin': window.location.origin
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                }
            });
        }
        
        function onPlayerReady(event) {
            console.log('[RELAY] Player Ready');
            isReady = true;
            
            sendToParent('ready', {
                duration: player.getDuration()
            });
            
            // Envoyer les infos vidéo après un court délai
            setTimeout(sendVideoInfo, 500);
        }
        
        function onPlayerStateChange(event) {
            console.log('[RELAY] State Change:', event.data);
            
            sendToParent('stateChange', {
                state: event.data
            });
            
            // Envoyer les infos vidéo quand la lecture commence
            if (event.data === YT.PlayerState.PLAYING) {
                sendVideoInfo();
            }
        }
        
        function onPlayerError(event) {
            console.log('[RELAY] Error:', event.data);
            
            sendToParent('error', {
                error: event.data
            });
        }
        
        // Écouter les commandes du parent
        window.addEventListener('message', function(event) {
            const data = event.data;
            if (!data || data.type !== 'command') return;
            if (data.playerId && data.playerId !== playerId) return;
            
            console.log('[RELAY] Received command:', data.command, data.args);
            
            if (!player || !isReady) {
                console.log('[RELAY] Player not ready, ignoring command');
                return;
            }
            
            try {
                const args = data.args || {};
                
                switch(data.command) {
                    case 'playVideo':
                        player.playVideo();
                        break;
                    
                    case 'pauseVideo':
                        player.pauseVideo();
                        break;
                    
                    case 'stopVideo':
                        player.stopVideo();
                        break;
                    
                    case 'loadVideoById':
                        if (args.videoId) {
                            player.loadVideoById({
                                videoId: args.videoId,
                                startSeconds: args.startSeconds || 0
                            });
                            // Envoyer les infos après chargement
                            setTimeout(sendVideoInfo, 1000);
                        }
                        break;
                    
                    case 'cueVideoById':
                        if (args.videoId) {
                            player.cueVideoById({
                                videoId: args.videoId,
                                startSeconds: args.startSeconds || 0
                            });
                        }
                        break;
                    
                    case 'seekTo':
                        if (typeof args.seconds !== 'undefined') {
                            player.seekTo(args.seconds, args.allowSeekAhead !== false);
                        }
                        break;
                    
                    case 'setVolume':
                        if (typeof args.volume !== 'undefined') {
                            player.setVolume(args.volume);
                        }
                        break;
                    
                    case 'mute':
                        player.mute();
                        break;
                    
                    case 'unMute':
                        player.unMute();
                        break;
                    
                    case 'getVideoData':
                        sendVideoInfo();
                        break;
                    
                    default:
                        console.log('[RELAY] Unknown command:', data.command);
                }
            } catch(e) {
                console.error('[RELAY] Command error:', e);
                sendToParent('error', {
                    error: 'Command failed: ' + e.message
                });
            }
        });
        
        // Gestion erreur globale
        window.addEventListener('error', function(e) {
            document.getElementById('player').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            sendToParent('error', {
                error: 'Load error: ' + e.message
            });
        });
    </script>
</body>
</html>
